{% extends "base.html" %}
{% load static %}
{% block title %}Create New Request {% endblock %}
{% block content %}
{% verbatim %}
<div id="vueapp">
  <div class="row">
    <div class="col-md-6">
      <h2>Request an Observation</h2>
    </div>
    <div class="col-md-6">
      <span class="pull-right">
      <h4>Duration: {{ duration }} seconds</h4>
      <!-- Top level userrequest fields -->
      <div class="control-group">
      <a href="#"><i class="fa fa-save"></i> Save Draft </a>
        <input type="checkbox" id="advanced" v-model="advanced">
        <label for="advanced">Advanced Mode</label>
      </div>
      </span>
    </div>
    <hr class="col-md-12">

    <!-- General Form -->
    <div class="col-md-12">
      <h2>General Info</h2>
    </div>
    <div class="col-md-6" id="general-help">
      <p>Please provide some general information about this observation request. </p>
      <dl>
        <dt>Title</dt>
        <dd>Provide a meaningful title for this observation request.</dd>
        <dt>Proposal</dt>
        <dd>Select the proposal for which this observation should be associated with.</dd>
        <dt>Ipp Value</dt>
        <dd>Select the Inter Proposal Priority for this request. More information about IPP can here:
            <a target="_blank" href="https://lco.global/files/User_Documentation/the_new_priority_factor.pdf">Increased Flexibility for Prioritizing Targets at LCOGT.</a>
        </dd>
        <dt>Priority</dt>
        <dd>Select whether this is a target of opportunity or not. ToO requests will interrupt currently running observations.</dd>
      </dl>
    </div>
    <div class="col-md-6">
      <form class="form-horizontal">
        <request-field id="title" label="Title" v-model="userrequest.group_id" :errpath="errors.group_id" size="col-sm-7"></request-field>
        <div class="form-group" :class="{'has-error': errors.proposal.length}">
          <label for="proposal" class="col-sm-3 control-label">Proposal</label>
          <div class="col-sm-7">
            <select id="proposal" v-model="userrequest.proposal" name="proposal" class="form-control">
              <option>Choose a proposal</option>
              <option v-for="proposal in proposals">{{ proposal }}</option>
            </select>
            <span class="help-block text-danger" v-for="error in errors.proposal">{{ error }}</span>
          </div>
        </div>
        <request-field id="ipp_value" label="Ipp Value" v-model="userrequest.ipp_value" :errpath="errors.ipp_value" size="col-sm-7"></request-field>
        <div class="form-group" :class="{'has-error': errors.observation_type.length}">
          <label for="priority" class="col-sm-3 control-label">Priority</label>
          <div class="col-sm-7">
            <select id="priority" v-model="userrequest.observation_type" class="form-control">
              <option value="NORMAL">Normal</option>
              <option value="TARGET_OF_OPPORTUNITY">Target Of Opportunity</option>
            </select>
            <span class="help-block text-danger" v-for="error in errors.observation_type">{{ error }}</span>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- For each Request -->
  <ul class="nav nav-pills nav-stacked" role="tablist">
    <li v-for="(request, reqIndex) in userrequest.requests" :class="{ active: reqTab === reqIndex}" role="presentation" v-on:click="reqTab = reqIndex">
      <a role="tab" data-toggle="tab">
        <span>Request {{ reqIndex + 1 }}</span>
        <span v-if="request.data_type">: {{ request.data_type }} using {{ request.instrument_name }}</span>
        <span v-if="request.target.name"> of {{ request.target.name }}</span>
      </a>
    </li>
    <li>
      <a class="pull-right" title="copy request" href="#" v-on:click="addRequest(userrequest.requests.length - 1); reqTab = userrequest.requests.length - 1"><i class="fa fa-plus"></i> Add request</a>
    </li>
  </ul>
  <div class="tab-content">
    <div role="tabpanel" v-for="(request, reqIndex) in userrequest.requests" class="tab-pane" :class="{ active: reqTab === reqIndex}" role="presentation">
      <div class="col-md-12">
        <h2> Child Request #{{ reqIndex + 1}}
          <small v-if="userrequest.requests.length > 1" class="pull-right"><a href="#" title="remove request" v-on:click="removeRequest(reqIndex)"><i class="fa fa-trash" ></i> Delete Request</a></small>
        </h2>
        <div class="alert alert-danger" role="alert" v-for="error in errors.requests[reqIndex].non_field_errors"> {{ error }}</div>
      </div>
      <div class="col-md-6">
        <p>Observation requests can have more than one child request. You can use this multiplicity to logically
        group several requests together. For example: Spectra and calibration requests can be grouped together
        to make the requests easier to track.</p>
        <dl>
          <dt>Data Type</dt>
          <dd>Choose <strong>Expose</strong> for imaging a target. Choose <strong>Spectra</strong> for use of a spectrograph.</dd>
          <dt>Instrument</dt>
          <dd>Please choose the instrument you would like to observe with. Descriptions of each instrument
          can be found here: <a href="https://lco.global/observatory/instruments/">LCO Instruments</a>.</dd>
        </dl>
      </div>
      <div class="col-md-6">
        <form class="form-horizontal">
          <div class="form-group">
            <label for="data-type" class="col-sm-3 control-label">Data Type</label>
            <div class="col-sm-7">
              <select id="data-type" v-model="request.data_type" class="form-control" v-on:change="changeDataType(reqIndex)">
                <option value="IMAGE">Image</option>
                <option value="SPECTRA">Spectra</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="instrument_name" class="control-label col-sm-3">Instrument</label>
            <div class="col-sm-7">
              <select id="instrument_name" v-model="request.instrument_name" class="form-control col-md-3" v-on:change="changeInstrument(reqIndex)" placeholder="Please select a data type">
                <option v-if="!request.data_type" value="" disabled>Please select a data type</option>
                <option v-for="instrumentType in instrumentTypes" :value="instrumentType.name" v-if="instrumentType.type === request.data_type">{{ instrumentType.name }}</option>
              </select>
            </div>
          </div>
        </form>
      </div>


      <!-- Target form -->
      <div class="col-md-12" id="target-form">
        <div class="row">
          <div class="col-md-12">
            <h3>Target</h3>
            <div class="alert alert-danger" role="alert" v-for="error in errors.requests[reqIndex].target.non_field_errors"> {{ error }}</div>
          </div>
          <div class="col-md-6">
            <p>Please provide details about the target of this observation.</p>
            <dl>
              <dt>Name</dt>
              <dd>The name of the target. If it is a known object, we will attempt to fill in coordinates</dd>
              <dt>Type</dt>
              <dd>Please select whether this is a <strong>sidereal</strong> or <strong>non-sidereal</strong> target.</dd>
            </dl>
          </div>
          <div class="col-md-6">
            <form class="form-horizontal">
              <request-field id="name" label="Name" v-model="request.target.name" :errpath="errors.requests[reqIndex].target.name" size="col-sm-3"></request-field>
              <div class="form-group">
                <label for="target_type" class="col-sm-3 control-label">Type</label>
                <div class="col-sm-7">
                  <select id="target_type" v-model="request.target.type" class="form-control" v-on:change="clearTargetFields(reqIndex)">
                    <option value="SIDEREAL">Sidereal</option>
                    <option value="NON_SIDEREAL">Non-Sidereal</option>
                  </select>
                  <span class="help-block text-danger" v-for="error in errors.requests[reqIndex].target.type">{{ error }}</span>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Sidereal form -->
        <div class="row" v-if="request.target.type == 'SIDEREAL'">
          <div class="col-md-6">
            <dl>
              <dt>Right Ascension</dt>
              <dd>The Right ascenscion of the target, in degrees or hours:minues:seconds</dd>
              <dt>Declination</dt>
              <dd>The declination of the target, in degrees.</dd>
            </dl>
          </div>
          <div class="col-md-6">
            <form class="form-horizontal">
              <request-field id="ra" label="Right Ascension" v-model="request.target.ra" :errpath="errors.requests[reqIndex].target.ra" size="col-md-2"></request-field>
              <request-field id="dec" label="Declination" v-model="request.target.dec" :errpath="errors.requests[reqIndex].target.dec" size="col-md-2"></request-field>
              <request-field id="proper_motion_ra" label="Proper Motion RA" v-if="advanced" v-model="request.target.proper_motion_ra" :errpath="errors.requests[reqIndex].target.proper_motion_ra" size="col-md-2"></request-field>
              <request-field id="proper_motion_dec" label="Proper Motion Dec" v-if="advanced" v-model="request.target.proper_motion_dec" :errpath="errors.requests[reqIndex].target.proper_motion_dec" size="col-md-2"></request-field>
              <request-field id="epoch" label="Epoch" v-if="advanced" v-model="request.target.epoch" :errpath="errors.requests[reqIndex].target.epoch" size="col-md-2"></request-field>
              <request-field id="parallax" label="Parallax" v-if="advanced" v-model="request.target.parallax" :errpath="errors.requests[reqIndex].target.parallax" size="col-md-2"></request-field>
            </form>
          </div>
        </div>

        <!-- NonSidereal Form -->
        <div class="row" v-if="request.target.type == 'NON_SIDEREAL'">
          <div class="col-md-6">
            <dl>
              <dt>Scheme</dt>
              <dd>The orbital elements scheme to use for this target.</dd>
            </dl>
          </div>
          <div class="col-md-6">
            <form class="form-horizontal">
              <div class="form-group">
                <label for="scheme" class="control-label col-sm-3">Scheme</label>
                <div class="col-sm-7">
                  <select id="scheme" v-model="request.target.scheme" class="form-control">
                    <option value="MPC_MINOR_PLANET">MPC Minor Planet</option>
                    <option value="MPC_COMET">MPC Comet</option>
                  </select>
                  <span class="help-block text-danger" v-for="error in errors.requests[reqIndex].target.scheme">{{ error }}</span>
                </div>
              </div>
              <request-field id="epoch" label="Epoch (MJD)" v-model="request.target.epoch" :errpath="errors.requests[reqIndex].target.epoch" size="col-md-2"></request-field>
              <request-field id="orbinc" label="Orbital Inclination" v-model="request.target.orbinc" :errpath="errors.requests[reqIndex].target.orbinc" size="col-md-2"></request-field>
              <request-field id="longascnode" label="Longitude of ascending Node" v-model="request.target.longascnode" :errpath="errors.requests[reqIndex].target.longascnode" size="col-md-3"></request-field>
              <request-field id="argofperih" label="Argument of Perihelion" v-model="request.target.argofperih" :errpath="errors.requests[reqIndex].target.argofperih" size="col-md-3"></request-field>
              <request-field id="meandist" label="Mean Distance (AU)" v-model="request.target.meandist" :errpath="errors.requests[reqIndex].target.meandist" size="col-md-2"></request-field>
              <request-field id="eccentricity" label="Eccentricity" v-model="request.target.eccentricity" :errpath="errors.requests[reqIndex].target.eccentricity" size="col-md-2"></request-field>
              <request-field id="meananom" label="Mean Anomoly" v-model="request.target.meananom" :errpath="errors.requests[reqIndex].target.meananom" size="col-md-2"></request-field>
            </form>
          </div>
        </div>
      </div>

      <!-- Window form -->
      <div class="col-md-12">
        <h3>Windows</h3>
        <div class="row" v-for="(window, winIndex) in request.windows">
          <div class="col-md-6">
            <p v-if="winIndex < 1">Enter the time windows in which you would like your request to be made.</p>
            <dl v-if="winIndex < 1">
              <dt>Start</dt>
              <dd>The lower limit of the time window.</dd>
              <dt>End</dt>
              <dd>The Upper end of fthe time window.</dd>
            </dl>
          </div>
          <div class="col-md-6">
            <h4><center>Window #{{ winIndex + 1 }}
              <small v-if="request.windows.length > 1"><a href="#" title="remove window" class="fa fa-trash" v-on:click="removeWindow(reqIndex, winIndex)"></a></small>
              <small><a class="fa fa-plus" title="copy window" href="#" v-on:click="addWindow(reqIndex, winIndex)"></a></small>
            </center></h4>
            <div class="alert alert-danger" role="alert" v-for="error in errors.requests[reqIndex].windows[winIndex].non_field_errors"> {{ error }}</div>
            <form class="form-horizontal">
              <request-field id="start" label="Start" v-model="window.start" :errpath="errors.requests[reqIndex].windows[winIndex].start" size="col-md-2"></request-field>
              <request-field id="end" label="End" v-model="window.end" :errpath="errors.requests[reqIndex].windows[winIndex].end" size="col-md-2"></request-field>
            </form>
          </div>
        </div>
      </div>

      <!-- Molecule Form -->
      <div class="col-md-12">
        <h3>Configurations</h3>
        <div class="row" v-for="(molecule, molIndex) in request.molecules">
          <div class="col-md-6">
            <p>Fill in the configuration details for this request</p>
            <dl>
              <dt>Filter/Slit</dt>
              <dd>The filter to be used if used with an imaging instrument, or slit to be used with a spectrograph.</dd>
            </dl>
          </div>
          <div class="col-md-6">
            <h4><center>Configuration #{{ molIndex + 1 }}
            <small v-if="request.molecules.length > 1"><a href="#" title="remove configuration" class="fa fa-trash" v-on:click="removeMolecule(reqIndex, molIndex)"></a></small>
            <small><a class="fa fa-plus" title="copy request" href="#" v-on:click="addMolecule(reqIndex, molIndex)"></a></small>
            </center></h4>
            <div class="alert alert-danger" role="alert" v-for="error in errors.requests[reqIndex].molecules[molIndex].non_field_errors"> {{ error }}</div>
            <form class="form-horizontal">
              <div class="row">
                <!-- common fields -->
                <div class="form-group">
                  <label for="filter" class="control-label col-sm-3" v-if="request.data_type === 'IMAGE' || !molecule.instrument_name">Filter</label>
                  <label for="filter" class="control-label col-sm-3" v-if="request.data_type === 'SPECTRA'">Slit</label>
                  <div class="col-sm-7">
                    <select id="filter" v-model="molecule.filter" class="form-control" v-if="molecule.instrument_name">
                      <option v-for="filter in instrumentTypes[molecule.instrument_name].filters" :value="filter">{{ filter }}</option>
                    </select>
                    <select id="filter" class="form-control" v-if="!molecule.instrument_name">
                      <option value="" disabled>Please select an instrment</option>
                    </select>
                    <span class="help-block text-danger" v-for="error in errors.requests[reqIndex].molecules[molIndex].filter">{{ error }}</span>
                  </div>
                </div>
                <div class="form-group">
                  <label for="binning" class="control-label col-sm-3">Binning</label>
                  <div class="col-sm-7">
                    <select id="binning" v-model="molecule.bin_x" class="form-control" v-if="molecule.instrument_name" v-on:change="updateBinning(reqIndex, molIndex)">
                      <option v-for="binning in instrumentTypes[molecule.instrument_name].binnings" :value="binning">{{ binning }}</option>
                    </select>
                    <select id="binning" class="form-control" v-if="!molecule.instrument_name">
                      <option value="" disabled>Please select an instrment</option>
                    </select>
                    <span class="help-block text-danger" v-for="error in errors.requests[reqIndex].molecules[molIndex].bin_x">{{ error }}</span>
                  </div>
                </div>
                <request-field id="exposure-time" label="Exposure Time" v-model="molecule.exposure_time" :errpath="errors.requests[reqIndex].molecules[molIndex].exposure_time" size="col-md-2"></request-field>
                <div class="form-group" :class="{'has-error': errors.requests[reqIndex].molecules[molIndex].exposure_count.length}">
                  <label for="exposure_count" class="control-label col-sm-3">Exposure Count</label>
                  <div class="col-sm-7">
                    <input id="exposure_count" class="form-control" v-model="molecule.exposure_count" :disabled="molecule.fill_window"/>
                    <span class="help-block text-danger" v-for="error in errors.requests[reqIndex].molecules[molIndex].exposure_count">{{ error }}</span>
                    <div class="checkbox">
                      <label>
                        <input id="fill_window" type="checkbox" v-model="molecule.fill_window" :disabled="request.windows.length > 1"/>
                        Fill Window <span class="text-danger" v-if="request.windows.length > 1">Can only be used with 1 window</span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>


              <!-- spectragraph fields -->
              <div class="row">
                <div class="form-group" v-if="request.data_type === 'SPECTRA'">
                  <label for="mol-type" class="control-label col-sm-3">Type</label>
                  <div class="col-sm-7">
                    <select id="mol-type" v-model="molecule.type" class="form-control">
                      <option value="SPECTRUM">Spectrum</option>
                      <option value="LAMP_FLAT">Lamp Flat</option>
                      <option value="ARC">ARC</option>
                    </select>
                    <span class="help-block text-danger" v-for="error in errors.requests[reqIndex].molecules[molIndex].type">{{ error }}</span>
                  </div>
                </div>
                <div class="form-group" v-if="request.data_type === 'SPECTRA'">
                  <label for="mol-type" class="control-label col-sm-3">Acquire Mode</label>
                  <div class="col-sm-7">
                    <select id="acquire_mode" v-model="molecule.acquire_mode" class="form-control">
                      <option value="OFF">Off</option>
                      <option value="WCS">WCS</option>
                      <option value="BRIGHTEST">Brightest</option>
                    </select>
                    <span class="help-block text-danger" v-for="error in errors.requests[reqIndex].molecules[molIndex].acquire_mode">{{ error }}</span>
                  </div>
                </div>
                <request-field v-if="request.data_type === 'SPECTRA' && molecule.acquire_mode === 'BRIGHTEST'" id="acquire_radius" label="Aqcuire radius" v-model="molecule.acquire_radius_arcsec" :errpath="errors.requests[reqIndex].molecules[molIndex].acquire_radius_arcsec" size="col-md-2"></request-field>
                <div class="form-group" v-if="request.data_type === 'SPECTRA'">
                  <label for="mol-type" class="control-label col-sm-3">Rotator Mode</label>
                  <div class="col-sm-7">
                    <select id="rot_mode" v-model="request.target.rot_mode" class="form-control">
                      <option value="SKY">Sky</option>
                      <option value="VFLOAT">Vertical Floating</option>
                    </select>
                    <span class="help-block text-danger" v-for="error in errors.requests[reqIndex].target.rot_mode">{{ error }}</span>
                  </div>
                </div>
                <request-field v-if="request.data_type === 'SPECTRA'" id="rot_angle" label="Rotator Angle" v-model="molecule.acquire_radius_arcsec" :errpath="errors.requests[reqIndex].molecules[molIndex].acquire_radius_arcsec" size="col-md-2"></request-field>
                <button class="btn btn-primary col-md-7 col-sm-offset-3" v-if="request.data_type === 'SPECTRA' && molecule.type === 'SPECTRUM'">Add Calibrations</button>
              </div>
            </form>
          </div>


        </div>
      </div>
      <div class="col-md-12">
        <div class="row">
          <div class="col-md-12">
            <h3>Constraints</h3>
            <div class="alert alert-danger" role="alert" v-for="error in errors.requests[reqIndex].constraints.non_field_errors"> {{ error }}</div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <p>Please provide the contraints you would like to impose as prerequisites to observation. The tighter the constraints the less
            likely the observation is to be successful</p>
            <dl>
              <dt>Max Airmass</dt>
              <dd>The maximum airmass at which this request should be considered for the target.</dd>
              <dt>Min Lunar Distance</dt>
              <dd>The minimum distance (in degrees) the target can be to the moon before the request is no longer considered</dd>
            </dl>
          </div>
          <div class="col-md-6">
            <form class="form-horizontal">
              <request-field id="max_airmass" label="Max. Airmass" v-model="request.constraints.max_airmass" :errpath="errors.requests[reqIndex].constraints.max_airmass" size="col-md-2"></request-field>
              <request-field id="min_lunar_distance" label="Min. Lunar Distance" v-model="request.constraints.min_lunar_distance" :errpath="errors.requests[reqIndex].constraints.min_lunar_distance" size="col-md-3"></request-field>
            </form>
          </div>
        </div>
      </div>
      <hr class="col-md-12"/>
    </div>
    <div class="row">
      <div class="col-md-12">
        <button class="btn btn-default" :disabled="hasError" v-on:click="submitRequest()">Submit Request</button>
      </div>
    </div>
  </div>
</div>
{% endverbatim %}
{% endblock %}
{% block extra_javascript %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.1.8/vue.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
<script src="{% static 'js/request_create.js' %}"></script>
{% endblock %}
