{% extends "base.html" %}
{% load static %}
{% block title %}Create New Request {% endblock %}
{% block extra_css %}
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.43/css/bootstrap-datetimepicker.min.css">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.18.1/vis.min.css">
{% endblock %}
{% block content %}
{% verbatim %}
<div id="vueapp">
  <div class="row">
    <div class="col-md-11">
      <alert v-for="alert in alerts" :alertclass="alert.class || 'alert-danger'">{{ alert.msg }}</alert>
    </div>
  </div>
  <div id="tabs">
    <ul class="nav nav-tabs col-md-6">
      <li :class="{ active: tab === 1 }" v-on:click="tab = 1">
        <a title="Observing request form."><i class="fa fa-fw fa-pencil-square-o fa-2x"></i> Form</a>
      </li>
      <li :class="{ active: tab === 2 }" v-on:click="tab = 2">
        <a title="Your observing request displayed in the request API language."><i class="fa fa-fw fa-code fa-2x"></i> Api View</a>
      </li>
      <li :class="{ active: tab === 3 }" v-on:click="tab = 3">
        <a title="Your saved observing requests."><i class="fa fa-fw fa-file-text-o fa-2x"></i> Drafts</a>
      </li>
    </ul>
    <div class="col-md-5 panel-actions">
      <span :class="draftId > -1 ? 'btn-group' : ''">
        <button class="btn btn-info" title="Save a draft of this observing request. The request will not be submitted"
                v-on:click="saveDraft(draftId)">
          <i class="fa fa-save"></i> Save Draft <span v-show="draftId > -1">#{{ draftId }}</span>
        </button>
         <button v-show="draftId > -1" type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown">
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li><a v-on:click="saveDraft(-1)">Save as new draft</a></li>
        </ul>
      </span>
      <a class="btn btn-success" title="Submit" v-on:click="submit" :disabled="!_.isEmpty(errors)" ><i class="fa fa-check"></i> Submit</a>
    </div>
    <div class="tab-content">
      <div class="tab-pane" :class="{ active: tab === 1 }">
        <div class="row">
          <div class="col-md-11 col-sm-12 col-sm-12">
            <userrequest ref="userrequest" :errors="errors" :duration_data="duration_data" :userrequest="userrequest"
                         v-on:userrequestupdate="userrequestUpdated"></userrequest>
          </div>
          <div class="col-md-1 hidden-sm hidden-xs">
            <sidenav :userrequest="userrequest"></sidenav>
          </div>
        </div>
      </div>
      <div class="tab-pane" :class="{ active: tab === 2 }">
        <div class="row">
          <div class="col-md-12">
            <p>This is the code that can be used to submit this overvation using the Request submission API.
            Submitting via API allows you to submit observations for scheduling using programming languages like python.</p>
            <p>For more information see the <a href="https://developers.lco.global/pages/request-service.html">API Documentation</a></p>
            <pre>{{ JSON.stringify(userrequest, null, 4) }}</pre>
          </div>
        </div>
      </div>
      <div class="tab-pane" :class="{ active: tab === 3 }">
        <div class="row">
          <div class="col-md-12">
            <drafts v-on:loaddraft="loadDraft" :tab="tab"></drafts>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/x-template" id="userrequest-template">
  <div class="row userrequestc" id="general">
    <div class="col-md-12">
      <div class="panel panel-default">
        <div class="panel-heading panel-heading-compact">
          <div class="row">
            <div class="col-xs-4">
              <i class="fa fa-id-card-o fa-2x fa-fw"></i>
              <i title="Errors in form" class="fa fa-warning fa-2x fa-fw text-danger" v-show="!_.isEmpty(errors)"></i>
              <i title="Section is complete" class="fa fa-check fa-2x fa-fw text-success" v-show="_.isEmpty(errors)"></i>
            </div>
            <div class="panel-title col-xs-4">
              General Information
            </div>
            <div class="panel-actions col-xs-4">
              <a class="btn btn-info btn-xs" v-on:click="show = !show" :title="show ? 'Minimize' : 'Maximize'">
                <i class="fa fa-fw" :class="show ? 'fa-window-minimize' : 'fa-window-maximize'"></i>
              </a>
            </div>
          </div>
        </div>
        <div class="panel-body panel-body-compact">
          <div v-for="error in errors.non_field_errors" class="alert alert-danger" role="alert">{{ error }}</div>
            <div class="row">
              <div class="col-md-6 compose-help" v-show="show">
                <dl>
                  <dt>Duration of Observing Request</dt>
                  <dd>Time that will be deducted from your proposal when this request is completed.</dd>
                  <dt>Title</dt>
                  <dd>Provide a name for this observing request.</dd>
                  <dt>Proposal</dt>
                  <dd>Select the proposal for which this observation will be made.</dd>
                  <dt>Priority</dt>
                  <dd>Select whether this request should be executed immediately (i.e. within 12 min of submission).
                      <a href="https://lco.global/documentation/">More information about Rapid Response mode.
                  </dd>
                  <dt>Ipp Factor</dt>
                  <dd>Provide an InterProposal Priority factor for this request.
                      <a target="_blank" href="https://lco.global/files/User_Documentation/the_new_priority_factor.pdf">
                         More information about IPP.
                      </a>
                  </dd>
                </dl>
              </div>
              <div :class="show ? 'col-md-6' : 'col-md-12'">
                <form class="form-horizontal">
                  <div class="row duration" v-show="show">
                    <span class="col-md-4"><strong>Total Duration</strong></span>
                    <span class="col-md-8">{{ durationDisplay }}</span>
                  </div>
                  <custom-field v-model="userrequest.group_id" label="Title" field="title" v-on:input="update" :errors="errors.group_id">
                  </custom-field>
                  <custom-select v-model="userrequest.proposal" label="Proposal" field="proposal" v-on:input="update"
                                 :errors="errors.proposal" :options="proposalOptions">
                  </custom-select>
                  <custom-select v-model="userrequest.observation_type" label="Priority" field="observation_type" v-on:input="update"
                                :errors="errors.observation_type"
                                :options="[{value: 'NORMAL', text: 'Queue scheduled (default)'},
                                           {value:'TARGET_OF_OPPORTUNITY', text: 'Rapid Response'}]">
                  </custom-select>
                  <custom-field v-model="userrequest.ipp_value" label="Ipp Factor" field="ipp_value"
                                v-on:input="update" :errors="errors.ipp_value">
                  </custom-field>
                  <div class="collapse-inline" v-show="!show">Total Duration: <strong>{{ durationDisplay }}</strong></div>
                </form>
              </div>
            </div>
            <div v-for="(request, idx) in userrequest.requests">
              <modal :show="showCadence" v-on:close="cancelCadence" v-on:submit="acceptCadence" header="Generated Cadence">
                <p>The blocks below represent the windows of the requests that will be generated if the current cadence is accepted.
                Press cancel to discard the cadence. Once a cadence is accepted, the individual generated requests may be edited.</p>
                <cadence :data="cadenceRequests"></cadence>
              </modal>
              <request ref="request" :index="idx" :request="request" :iavailable_instruments="available_instruments" :parentshow="show"
                       v-on:requestupdate="requestUpdated" v-on:cadence="expandCadence"
                       :errors="_.get(errors, ['requests', idx], {})"
                       :duration_data="_.get(duration_data, ['requests', idx], {'duration': 0})">
              </request>
              <div class="request-margin"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/x-template" id="request-template">
  <div class="row request" :id="'request' + index">
    <div class="col-md-12">
      <div class="panel panel-warning">
        <div class="panel-heading panel-heading-compact">
          <div class="row">
            <div class="col-xs-4">
              <i class="fa fa-wpexplorer fa-2x fa-fw"></i>
              <i title="Errors in form" class="fa fa-warning fa-2x fa-fw text-danger" v-show="!_.isEmpty(errors)"></i>
              <i title="Section is complete" class="fa fa-check fa-2x fa-fw text-success" v-show="_.isEmpty(errors)"></i>
            </div>
            <div class="panel-title col-xs-4">
              Request <span v-show="index > 0">#{{ index + 1}}</span>
            </div>
            <div class="panel-actions col-xs-4">
              <a class="btn btn-danger btn-xs" v-on:click="$parent.removeRequest(index)" v-show="$parent.userrequest.requests.length > 1" title="Delete">
                <i class="fa fa-trash fa-fw"></i>
              </a>
              <a class="btn btn-success btn-xs" title="Copy" v-on:click="$parent.addRequest(index)"><i class="fa fa-copy fa-fw"></i></a>
              <a class="btn btn-info btn-xs" v-on:click="show = !show" :title="show ? 'Minimize' : 'Maximize'">
                <i class="fa fa-fw" :class="show ? 'fa-window-minimize' : 'fa-window-maximize'"></i>
              </a>
            </div>
          </div>
        </div>
        <div class="panel-body panel-body-compact">
          <div v-for="error in errors.non_field_errors" class="alert alert-danger" role="alert">{{ error }}</div>
          <div class="row">
            <div class="col-md-6 compose-help" v-show="show">
              <dl>
                <dt>Instrument</dt>
                <dd>Select the instrument with which this observation will be made.
                <a target="_blank" href="https://lco.global/observatory/instruments/">More information about LCO instruments</a>.</dd>
              </dl>
            </div>
            <div :class="show ? 'col-md-6' : 'col-md-12'">
              <form class="form-horizontal">
                 <custom-select v-model="data_type" label="Observation Type" v-on:input="update" :errors="errors.data_type"
                                :options="[{value:'IMAGE', text: 'Image'}, {value:'SPECTRA', text:'Spectrum'}]">
                </custom-select>
                <custom-select v-model="instrument_name" label="Instrument" field="instrument_name"
                               :errors="errors.instrument_name" :options="availableInstrumentOptions">
                </custom-select>
              </form>
            </div>
          </div>
          <target ref="target" :target="request.target" v-on:targetupdate="targetUpdated" :datatype="data_type" :parentshow="show" :errors="_.get(errors, 'target', {})">
          </target>
          <div v-for="(molecule, idx) in request.molecules">
            <molecule ref="molecule" :index="idx" :molecule="molecule" :selectedinstrument="instrument_name" :datatype="data_type" :parentshow="show"
                      v-on:moleculeupdate="moleculeUpdated" v-on:moleculefillwindow="moleculeFillWindow"
                      :errors="_.get(errors, ['molecules', idx], {})"
                      :duration_data="_.get(duration_data, ['molecules', idx], {'duration':0})">
            </molecule>
          </div>
          <div v-for="(window, idx) in request.windows">
            <window ref="window" :index="idx" :window="window" v-on:windowupdate="windowUpdated" :parentshow="show" v-on:cadence="cadence"
                    :errors="_.get(errors, ['windows', idx], {})">
            </window>
          </div>
          <constraints ref="constraints" :constraints="request.constraints" v-on:constraintsupdate="constraintsUpdated" :parentshow="show" :errors="_.get(errors, 'constraints', {})">
          </constraints>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/x-template" id="molecule-template">
  <div class="row target" :id="'molecule' + $parent.index + index">
    <div class="col-md-12">
      <div class="panel panel-default">
        <div class="panel-heading panel-heading-compact">
          <div class="row">
            <div class="col-xs-4">
              <i class="fa fa-cogs fa-2x fa-fw"></i>
              <i title="Errors in form" class="fa fa-warning fa-2x fa-fw text-danger" v-show="!_.isEmpty(errors)"></i>
              <i title="Section is complete" class="fa fa-check fa-2x fa-fw text-success" v-show="_.isEmpty(errors)"></i>
            </div>
            <div class="panel-title col-xs-4">
              Configuration <span v-show="index > 0">#{{ index + 1 }}</span>
            </div>
            <div class="panel-actions col-xs-4">
              <a class="btn btn-danger btn-xs" v-on:click="$parent.removeMolecule(index)" v-show="$parent.request.molecules.length > 1" title="Remove">
                <i class="fa fa-trash fa-fw"></i>
              </a>
              <a class="btn btn-success btn-xs" v-on:click="$parent.addMolecule(index)" title="Copy"><i class="fa fa-copy fa-fw"></i></a>
              <a class="btn btn-info btn-xs" v-on:click="show = !show" :title="show ? 'Minimize' : 'Maximize'">
                <i class="fa fa-fw" :class="show ? 'fa-window-minimize' : 'fa-window-maximize'"></i>
              </a>
            </div>
          </div>
        </div>
        <div class="panel-body panel-body-compact">
          <div v-for="error in errors.non_field_errors" class="alert alert-danger" role="alert">{{ error }}</div>
          <div class="row">
            <div class="col-md-6 compose-help" v-show="show">
              <dl>
                <dt>Filter/Slit</dt>
                <dd>The filter to be used if used with an imaging instrument, or slit to be used with a spectrograph.</dd>
                <dt>Binning</dt>
                <dd>Number of CCD pixels in X and Y to bin together. The recommended binning will be selected by default.</dd>
                <dt>Exposure Count</dt>
                <dd>Number of exposures to make with this configuration.</dd>
                <dt>Exposure Time</dt>
                <dd>Seconds</dd>
              </dl>
              <dl v-show="datatype === 'SPECTRA'">
                <dt>Type</dt>
                <dd>The type of exposure (allows for calibrations).</dd>
                <dt>Acquire Mode</dt>
                <dd>How the target is acquired.</dd>
              </dl>
            </div>
            <div :class="show ? 'col-md-6' : 'col-md-12'">
              <form class="form-horizontal">
                <custom-select v-model="molecule.filter" :label="datatype === 'IMAGE' ? 'Filter':'Slit Width'" v-on:input="update"
                               :errors="errors.filter" :options="filterOptions">
                </custom-select>
                <custom-select v-model="molecule.bin_x" label="Binning" v-on:input="binningsUpdated"
                               :errors="errors.bin_x" :options="binningsOptions">
                </custom-select>
                <custom-field v-model="molecule.exposure_count" label="Exposure Count" field="exposure_count" v-on:input="update"
                                :errors="errors.exposure_count">
                  <div class="input-group-btn" slot="inlineButton">
                    <button class="btn btn-default" type="button" style="font-size:16px" v-on:click="fillWindow"
                            :disabled="duration_data.duration > 0 ? false : true"><b>Fill</b></button>
                  </div>
                </custom-field>
                <custom-field v-model="molecule.exposure_time" label="Exposure Time" field="exposure_time" v-on:input="update"
                              :errors="errors.exposure_time">
                </custom-field>
                <div class="spectra" v-if="datatype === 'SPECTRA'">
                  <custom-select v-model="molecule.type" label="Type" v-on:input="update" :errors="errors.type"
                                 :options="[{value: 'SPECTRUM', text: 'Spectrum'},
                                            {value: 'LAMP_FLAT', text: 'Lamp Flat'},
                                            {value: 'ARC', text:'Arc'}]">
                  </custom-select>
                  <custom-select v-model="molecule.acquire_mode" label="Acquire Mode" v-on:input="update" :errors="errors.acquire_mode"
                                 :options="[{value: 'OFF', text: 'Off'},
                                            {value: 'WCS', text: 'WCS'},
                                            {value: 'BRIGHTEST', text: 'Brightest'}]">
                  </custom-select>
                  <custom-field v-show="molecule.acquire_mode === 'BRIGHTEST'" v-model="molecule.acquire_radius_arcsec" field="acquire_radius_arcsec"
                                label="Acquire Radius" v-on:input="update" :errors="errors.acquire_radius_arcsec">
                  </custom-field>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/x-template" id="target-template">
  <div class="row target" :id="'target' + $parent.index">
    <div class="col-md-12">
      <div class="panel panel-default">
        <div class="panel-heading panel-heading-compact">
          <div class="row">
            <div class="col-xs-4">
              <i class="fa fa-crosshairs fa-2x fa-fw"></i>
              <i title="Errors in form" class="fa fa-warning fa-2x fa-fw text-danger" v-show="!_.isEmpty(errors)"></i>
              <i title="Section is complete" class="fa fa-check fa-2x fa-fw text-success" v-show="_.isEmpty(errors)"></i>
            </div>
            <div class="panel-title col-xs-4">
              Target
            </div>
            <div class="panel-actions col-xs-4">
              <a class="btn btn-info btn-xs" v-on:click="show = !show" :title="show ? 'Minimize' : 'Maximize'">
                <i class="fa fa-fw" :class="show ? 'fa-window-minimize' : 'fa-window-maximize'"></i>
              </a>
            </div>
          </div>
        </div>
        <div class="panel-body panel-body-compact">
          <div v-for="error in errors.non_field_errors" class="alert alert-danger" role="alert">{{ error }}</div>
          <div class="row">
            <div class="col-md-6 compose-help" v-show="show">
              <dl>
                <dt>Type</dt>
                <dd>Please select whether this is a <strong>sidereal</strong> or <strong>non-sidereal</strong> target.</dd>
              </dl>
              <dl v-show="target.type === 'SIDEREAL'">
                <dt>Right Ascension</dt>
                <dd>Decimal degrees or HH:MM:SS.S</dd>
                <dt>Declination</dt>
                <dd>Decimal degrees of DD:MM:SS.S</dd>
                <dt>Proper Motion RA</dt>
                <dd>&plusmn;0.33 mas/year</dd>
                <dt>Proper Motion Dec</dt>
                <dd>&plusmn;0.33 mas/year</dd>
                <dt>Epoch</dt>
                <dd>Julian Years</dd>
                <dt>Parallax</dt>
                <dd>+0.45 mas</dd>
              </dl>
              <dl v-show="target.type === 'NON_SIDEREAL'">
                <dt>Scheme</dt>
                <dd>The orbital elements scheme to use with this target</dd>
                <dt>Epoch</dt>
                <dd>Modified Julian Days</dd>
                <dt>Longitude of Ascending Node</dt>
                <dd>Andle in Degrees</dd>
                <dt>Argument of Perihelion</dt>
                <dd>Angle in Degrees</dd>
                <dt>Mean Distance</dt>
                <dd>Astronomical Units</dd>
                <dt>Eccentricity</dt>
                <dd>0 to 0.99</dd>
                <dt>Mean Anomaly</dt>
                <dd>fAngle in Degrees</dd>
              </dl>
            </div>
            <div :class="show ? 'col-md-6' : 'col-md-12'">
              <form class="form-horizontal">
                <custom-field v-model="target.name" label="Target Name" field="name" v-on:input="update" :errors="errors.name">
                </custom-field>
                <div class="row" v-show="lookingUP">
                    <span class="col-md-12" style="text-align: right">
                      <i class="fa fa-spinner fa-spin fa-fw"></i> Looking up coordinates...
                    </span>
                </div>
                <custom-select v-model="target.type" label="Type" field="type" v-on:input="update" :errors="errors.type"
                               :options="[{value: 'SIDEREAL',text: 'Sidereal'}, {value: 'NON_SIDEREAL',text:'Non-Sidereal'}]">
                </custom-select>
                <div class="sidereal" v-if="target.type === 'SIDEREAL'">
                  <custom-field v-model="target.ra" label="Right Ascension" type="sex" field="ra" v-on:blur="updateRA" :errors="errors.ra">
                  </custom-field>
                  <custom-field v-model="target.dec" label="Declination" type="sex" field="dec" v-on:blur="updateDec" :errors="errors.dec">
                  </custom-field>
                  <custom-field v-model="target.proper_motion_ra" label="Proper Motion: RA" field="proper_motion_ra"
                                v-on:input="update" :errors="errors.proper_motion_ra">
                  </custom-field>
                  <custom-field v-model="target.proper_motion_dec" label="Proper Motion: Dec" field="proper_motion_dec"
                                v-on:input="update" :errors="errors.proper_motion_dec">
                  </custom-field>
                  <custom-field v-model="target.epoch" label="Epoch" field="epoch" v-on:input="update" :errors="errors.epoch">
                  </custom-field>
                  <custom-field v-model="target.parallax" label="Parallax" field="parallax" v-on:input="update"
                                :errors="errors.parallax">
                  </custom-field>
                </div>
                <div class="non-sidereal" v-if="target.type === 'NON_SIDEREAL'">
                  <custom-select v-model="target.scheme" label="Scheme" field="scheme" v-on:input="update" :errors="errors.scheme"
                                 :options="[{value: 'MPC_MINOR_PLANET', text: 'MPC Minor Planet'},
                                            {value: 'MPC_COMET', text: 'MPC Comet'}]">
                  </custom-select>
                  <custom-field v-model="target.epoch" label="Epoch" field="epoch" v-on:input="update" :errors="errors.epoch">
                  </custom-field>
                  <custom-field v-model="target.orbinc" label="Orbital Inclination" field="orbinc" v-on:input="update"
                                :errors="errors.orbinc">
                  </custom-field>
                  <custom-field v-model="target.longascnode" label="Longitude of Ascending Node" field="longascnode"
                                v-on:input="update" :errors="errors.longascnode">
                  </custom-field>
                  <custom-field v-model="target.argofperih" label="Argument of Perihelion" field="argofperih"
                                v-on:input="update" :errors="errors.argofperih">
                  </custom-field>
                  <custom-field v-model="target.meandist" label="Mean Distance (AU)" field="meandist"
                                v-on:input="update" :errors="errors.meandist">
                  </custom-field>
                  <custom-field v-model="target.eccentricity" label="Eccentricity" field="eccentricity"
                                v-on:input="update" :errors="errors.eccentricity">
                  </custom-field>
                  <custom-field v-model="target.meananom" label="Mean Anomoly" field="meananom"
                                v-on:input="update" :errors="errors.meananom">
                  </custom-field>
                </div>
                <div class="spectra" v-if="datatype === 'SPECTRA'">
                  <custom-select v-model="target.rot_mode" label="Rotator Mode" field="rot_mode" v-on:input="update" :errors="errors.rot_mode"
                                 :options="[{value: 'SKY', text: 'Sky'}, {value: 'VFLOAT', text: 'Vertical Floating'}]">
                  </custom-select>
                  <custom-field v-model="target.rot_angle" label="Rotator Angle" field="rot_angle" v-on:input="update" :errors="errors.rot_angle">
                  </custom-field>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/x-template" id="window-template">
  <div class="row window" :id="'window' + $parent.index + index">
    <div class="col-md-12">
      <div class="panel panel-default">
        <div class="panel-heading panel-heading-compact">
          <div class="row">
            <div class="col-xs-4">
              <i class="fa fa-calendar fa-2x fa-fw"></i>
              <i title="Errors in form" class="fa fa-warning fa-2x fa-fw text-danger" v-show="!_.isEmpty(errors)"></i>
              <i title="Section is complete" class="fa fa-check fa-2x fa-fw text-success" v-show="_.isEmpty(errors)"></i>
            </div>
            <div class="panel-title col-xs-4">
              Window <span v-show="index > 0">#{{ index + 1}}</span>
            </div>
            <div class="panel-actions col-xs-4">
              <a class="btn btn-xs btn-danger" v-on:click="$parent.removeWindow(index)" v-show="$parent.request.windows.length > 1" title="remove">
                <i class="fa fa-trash fa-fw"></i>
              </a>
              <a class="btn btn-xs btn-success" v-on:click="$parent.addWindow(index)" title="copy"><i class="fa fa-copy fa-fw"></i></a>
              <a class="btn btn-info btn-xs" v-on:click="show = !show" :title="show ? 'Minimize' : 'Maximize'">
                <i class="fa fa-fw" :class="show ? 'fa-window-minimize' : 'fa-window-maximize'"></i>
              </a>
            </div>
          </div>
        </div>
        <div class="panel-body panel-body-compact">
          <div v-for="error in errors.non_field_errors" class="alert alert-danger" role="alert">{{ error }}</div>
          <div class="row">
            <div class="col-md-6 compose-help" v-show="show">
              <dl>
                <dt>Start</dt>
                <dd>Time when the observing window opens.</dd>
                <dt>End</dt>
                <dd>Time when the observing window closes.</dd>
                <dt>Cadence</dt>
                <dd>Option to specify periodic observations within this window.
                <strong>This will remove all previously created windows.</strong>
                </dd>
                <dt v-show="cadence">Period</dt>
                <dd v-show="cadence">Fractional hours</dd>
                <dt v-show="cadence">Jitter</dt>
                <dd v-show="cadence">Acceptable deviation (before or after) from strict period.</dd>
              </dl>
            </div>
            <div :class="show ? 'col-md-6' : 'col-md-12'">
              <form class="form-horizontal" >
                <custom-field v-model="window.start" type="datetime" label="Start (UT)" field="start" v-on:input="update" :errors="errors.start">
                </custom-field>
                <custom-field v-model="window.end" type="datetime" label="End (UT)" field="end" v-on:input="update" :errors="errors.end">
                </custom-field>
                <div class="checkbox col-sm-8 col-sm-offset-4">
                  <label>
                    <input type="checkbox" v-model="cadence">Observe as a cadence
                  </label>
                </div>
                <custom-field v-model="period" label="Period" field="period" v-on:input="update" :errors="errors.period" v-show="cadence">
                </custom-field>
                <custom-field v-model="jitter" label="Jitter" field="jitter" v-on:input="update" :errors="errors.jitter" v-show="cadence">
                </custom-field>
                <a class="btn btn-info col-sm-8 col-sm-offset-4" v-on:click="genCadence" v-show="cadence">Generate Cadence</a>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/x-template" id="constraints-template">
  <div class="row constraints" :id="'constraints' + $parent.index">
    <div class="col-md-12">
      <div class="panel panel-default">
        <div class="panel-heading panel-heading-compact">
          <div class="row">
            <div class="col-xs-4">
              <i class="fa fa-lock fa-2x fa-fw"></i>
              <i title="Errors in form" class="fa fa-warning fa-2x fa-fw text-danger" v-show="!_.isEmpty(errors)"></i>
              <i title="Section is complete" class="fa fa-check fa-2x fa-fw text-success" v-show="_.isEmpty(errors)"></i>
            </div>
            <div class="panel-title col-xs-4">
              Constraints
            </div>
            <div class="panel-actions col-xs-4">
              <a class="btn btn-info btn-xs" v-on:click="show = !show" :title="show ? 'Minimize' : 'Maximize'">
                <i class="fa fa-fw" :class="show ? 'fa-window-minimize' : 'fa-window-maximize'"></i>
              </a>
            </div>
          </div>
        </div>
        <div class="panel-body panel-body-compact">
          <div v-for="error in errors.non_field_errors" class="alert alert-danger" role="alert">{{ error }}</div>
          <div class="row">
            <div class="col-md-6 compose-help" v-show="show">
              <dl>
                <dt>Maximum Airmass</dt>
                <dd>Airmass = 1 at zenith.</dd>
                <dt>Minimum Lunar Separation</dt>
                <dd>Minimum acceptable angular separation between the target and the moon.</dd>
              </dl>
            </div>
            <div :class="show ? 'col-md-6' : 'col-md-12'">
              <form class="form-horizontal">
                <custom-field v-model="constraints.max_airmass" label="Maximum Airmass" field="max_airmass" v-on:input="update"
                              :errors="errors.max_airmass">
                </custom-field>
                <custom-field v-model="constraints.min_lunar_distance" label="Min. Lunar Distance" field="min_lunar_distance" v-on:input="update"
                              :errors="errors.min_lunar_distance">
                </custom-field>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/x-template" id="custom-field">
  <span>
    <div class="form-group" :class="{ 'has-error': errors }" v-show="$parent.show">
      <label :for="field" class="col-sm-4 control-label">{{ label }}</label>
      <div class="col-sm-8">
        <div class="input-group" style="width:100%;">
          <input :id="field" class="form-control" v-bind:value="value" v-on:blur="blur($event.target.value)"
                 v-on:input="update($event.target.value)" :name="field" :type="type || 'text'"/>
          <slot name="inlineButton"></slot>
        </div>
        <span class="help-block text-danger" v-for="error in errors">{{ error }}</span>
      </div>
    </div>
    <span class="collapse-inline" v-show="!$parent.show">{{ label }}: <strong>{{ value || '...' }}</strong></span>
  </span>
</script>

<script type="text/x-template" id="custom-select">
  <span>
    <div class="form-group" :class="{ 'has-error': errors }" v-show="$parent.show">
      <label :for="field" class="col-sm-4 control-label">{{ label }}</label>
      <div class="col-sm-8">
        <select :id="field" v-bind:value="value" v-on:change="update($event.target.value)"
                :name="field" class="form-control">
          <option v-for="option in options" :value="option.value" :selected="isSelected(option.value)" v-html="option.text"></option>
        </select>
        <span class="help-block text-danger" v-for="error in errors">{{ error }}</span>
      </div>
    </div>
    <div class="collapse-inline" v-show="!$parent.show">{{ label }}: <strong>{{ value || '...' }}</strong></div>
  </span>
</script>

<script type="text/x-template" id="sidenav-template">
  <nav class="bs-docs-sidebar">
    <ul id="sidebar" class="nav nav-stacked">
      <li><a href="#general">General Info</a></li>
      <li v-for="(request, index) in userrequest.requests">
        <a :href="'#request' + index">Request #{{ index + 1}}</a>
        <ul class="nav nav-stacked">
          <li>
            <a :href="'#target' + index">Target</a>
          </li>
          <li v-for="(molecule, molIndex) in request.molecules">
            <a :href="'#molecule' + index + molIndex"> Configutation #{{ molIndex + 1}}</a>
          </li>
          <li v-for="(window, winIndex) in request.windows">
            <a :href="'#window' + index + winIndex">Window #{{ winIndex + 1}}</a>
          </li>
          <li>
            <a :href="'#constraints' + index">Constraints</a>
          </li>
        </ul>
      </li>
    </ul>
  </nav>
</script>

<script type="text/x-template" id="drafts-template">
  <table class="table table-striped">
    <thead>
      <tr><td>Load</td><td>Title</td><td>Id</td><td>Author</td><td>Proposal</td><td>Last Modified</td><td>Delete</td></tr>
    </thead>
    <tbody>
      <tr v-show="drafts.length < 1">
        <td colspan="7">You have no draft observing requests.</td>
      </tr>
      <tr v-for="draft in drafts">
        <td><button class="btn btn-info" v-on:click="loadDraft(draft.id)"><i class="fa fa-download"></i></button></td>
        <td>{{ draft.title }}</td>
        <td>{{ draft.id }}</td>
        <td>{{ draft.author }}</td>
        <td>{{ draft.proposal }}</td>
        <td>{{ draft.modified | formatDate  }}</td>
        <td><button class="btn btn-danger" v-on:click="deleteDraft(draft.id)"><i class="fa fa-trash"></i></button></td>
      </tr>
  </table>
</script>

<script type="text/x-template" id="modal-template">
  <div class="vueModal">
    <div class="modal" tabindex="-1" v-bind:class="{ in: open }" v-bind:style="modalStyle">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            {{ header }}
          </div>
          <div class="modal-body">
            <slot></slot>
          </div>
          <div class="modal-footer">
            <a class="btn btn-default" v-on:click="close">Cancel</a>
            <a class="btn btn-primary" v-on:click="submit">Accept</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/x-template" id="alert-template">
  <div class="alert alert-dismissiable" :class="alertclass" role="alert">
    <slot></slot>
    <button class="close" data-dismiss="alert"><i class="fa fa-times"></i></button>
  </div>
</script>

{% endverbatim %}
{% endblock %}
{% block extra_javascript %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.1.8/vue.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.43/js/bootstrap-datetimepicker.min.js"></script>
<script src="https://s3-us-west-2.amazonaws.com/cdn.lcogt.net/script/utils.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.18.1/vis.min.js"></script>
<script src="{% static 'js/request_create.js' %}"></script>
{% endblock %}
