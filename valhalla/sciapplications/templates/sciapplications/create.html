{% extends "base.html" %}
{% load i18n static bootstrap3 %}

{% block title %}{% trans "Submit Application" %}{% endblock %}
{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/sciapplications.css' %}">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <ol class="breadcrumb">
          <li><a href="{% url 'sciapplications:index' %}">Calls for Proposals</a></li>
          <li class="active">Submit proposal</li>
        </ol>
    </div>
</div>
<div class="row">
    <div class="col-md-9">
        <p>You are creating a proposal for {{ call.semester }}.</p>
        {% if call.proposal_type != 'DDT' %}
        <p>Deadline: <strong>{{ call.deadline|date:"j M Y P" }}</strong> ({{ call.deadline|timeuntil }})</p>
        {% endif %}
        <p>{{ call.eligibility }}</p>
        {% bootstrap_form_errors form %}
        <form method="post" action="" enctype="multipart/form-data" id="app_form">
            {% csrf_token %}

            {{ form.status }}
            {{ form.call }}

            {% if form.title %}
                {% bootstrap_field form.title %}
            {% endif %}

            {% if form.abstract %}
                {% bootstrap_field form.abstract %}
            {% endif %}

            {% if form.pi %}
                {% bootstrap_label 'Principal Investigator' label_for=id_pi %}
                <div class="help-block">
                {% blocktrans %}<strong>If this is not you</strong>, please add the details for the PI.{% endblocktrans %}
                </div>
                <table class="table table-striped">
                  <thead><tr><td>Email</td><td>First Name</td><td>Last Name</td><td>Institution</td></thead>
                  <tr>
                    <td>{% bootstrap_field form.pi show_label=false placeholder='Email' %}</td>
                    <td>{% bootstrap_field form.pi_first_name show_label=false placeholder='First Name' %}</td>
                    <td>{% bootstrap_field form.pi_last_name show_label=false placeholder='Last Name' %}</td>
                    <td>{% bootstrap_field form.pi_institution show_label=false placeholder='Institution' %}</td>
                  </tr>
                </table>
            {% endif %}

            {% bootstrap_label 'Co-investigators' %}
            <div class="help-block">
              {% blocktrans %}
              Add the details of co-investigators on this proposal.
              {% endblocktrans %}
            </div>
            <table class="table table-striped">
              <thead><tr><td>Email</td><td>First Name</td><td>Last Name</td><td>Institution</td></thead>
              <tbody>
                {% for form in ci_form.forms %}
                  {% bootstrap_form_errors form %}
                  {{ form.id }}
                  <tr class="ci-row">
                    <td>
                    {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
                    {% bootstrap_field form.email show_label=false %}
                    </td>
                    <td>{% bootstrap_field form.first_name show_label=false %}</td>
                    <td>{% bootstrap_field form.last_name show_label=false %}</td>
                    <td>{% bootstrap_field form.institution show_label=false %}</td>
                  </tr>
                {% endfor %}
              </tbody>
              {{ ci_form.management_form }}
            </table>


            {% if timerequest_form %}
                {% bootstrap_label 'Observing Budget' %}
                <div class="help-block">
                {% blocktrans %}Requested observing time in hours for the semester. Time for <a href="https://lco.global/documentation/rapid-response-mode/" target="_blank">Rapid Response mode</a>
                (within 15 minutes of submission) observations must be requested separately.
                {% endblocktrans %}
                </div>
                {% bootstrap_formset_errors timerequest_form %}
                <table class="table table-striped">
                    <thead><tr><td>Instrument</td><td>Standard Time</td><td>Rapid Response</td></tr></thead>
                    <tbody>
                    {% for form in timerequest_form.forms %}
                    {% bootstrap_form_errors form %}
                    {{ form.id }}
                    <tr class="timerequest-row">
                        <td>
                        {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
                        {% bootstrap_field form.instrument show_label=false %}
                        </td>
                        <td>{% bootstrap_field form.std_time show_label=false %}</td>
                        <td>{% bootstrap_field form.too_time show_label=false %}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                    {{ timerequest_form.management_form }}
                </table>

            {% endif %}

            {% if form.moon %}
                {% bootstrap_field form.moon %}
            {% endif %}

            {% if form.science_justification %}
                {% bootstrap_field form.science_justification %}
            {% endif %}

            {% if form.ddt_justification %}
                {% bootstrap_label 'Justification of discretionary time' label_for=id_ddt_justification %}
                <div class="help-block">
                Discretionary time is reserved for observations of unforeseen targets-of-opportunity. Describe why this proposal must be reviewed now, rather than as part of the normal time allocation process for the upcoming semester. Additionally, please describe through what affiliation you are entitled to request DD time.
                </div>
                {% bootstrap_field form.ddt_justification show_label=False placeholder='DDT Justification' %}
            {% endif %}

            {% if form.management %}
                {% bootstrap_label 'Plan for management of entire scientific investigation' label_for=id_management %}
                {% bootstrap_field form.management show_label=False %}
            {% endif %}

            {% if form.relevance %}
                {% bootstrap_label 'Relevance to unique capabilities of the LCO network' label_for=id_relevance %}
                {% bootstrap_field form.relevance show_label=False %}
            {% endif %}

            {% if form.contribution %}
                {% bootstrap_label 'Contribution brought by non-LCO participants' label_for=id_contribution %}
                {% bootstrap_field form.contribution show_label=False %}
            {% endif %}

            {% if form.pdf %}
                {% bootstrap_label 'Upload PDF' %}
                <div class="help-block">
                    The text for the PDF upload help here
                </div>
                {% bootstrap_field form.pdf show_label=False %}
            {% endif %}
        </form>
        <a href="#">Back to top</a>
    </div>
    <div class="col-md-3">
        <h3>{% trans 'Application status' %}:
            {% if form.instance.id %}
                {{ form.status.value }}
            {% else %}
                {% trans 'UNSAVED' %}
            {% endif %}
        </h3>
        {% blocktrans %}
        <p>You may save your application and work on it later.</p>
        <p>Once you submit your application, you will no longer be able to edit it.</p>
        {% endblocktrans %}
        {% buttons %}
        <a href="#" class="btn btn-default" id="save">{% trans 'Save' %}</a>
        <a href="#" class="btn btn-success" id="submit">{% trans 'Submit' %}</a>
        {% endbuttons %}
        {% if form.instance.id %}
        <p>Previewing your submission will <strong>discard</strong> any pending edits.</p>
        <p><a href="{% url 'sciapplications:detail' form.instance.id %}" class="btn btn-default" id="preview">{% trans 'Preview' %}</a></p>
        <p>{% trans 'Deleting a draft is an irreversible action' %}.</p>
        <p><a href="{% url 'sciapplications:delete' pk=form.instance.id %}" class="btn btn-danger">{% trans 'Delete' %}</a></p>
        {% endif %}
    </div>
</div>
{% endblock %}
{% block extra_javascript %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.formset/1.2.2/jquery.formset.min.js"></script>
<script type="text/javascript">
    function check_delete(row){
         if(row.siblings('tr').length < 1){
           row.find('.fa-trash').hide();
        }else{
           row.find('.fa-trash').show();
        }
    }
    function instantiateFormset(elem, prefix){
        elem.formset({
            prefix: prefix,
            deleteText: '<i class="fa fa-trash"></i>',
            addText: '<i class="fa fa-plus"></i> add another ',
            deleteCssClass: 'delete-' + prefix,
            formCssClass: 'form-' + prefix,
            added: function(row){
              check_delete(row);
              row.find('input[type=number]').val(0);
            },
            removed: function(row){
              check_delete(row);
            }
        });
      }

    $(document).ready(function(){
        instantiateFormset($('.ci-row'), '{{ ci_form.prefix }}');
        instantiateFormset($('.timerequest-row'), '{{ timerequest_form.prefix }}');
        check_delete($('.ci-row').first());
        check_delete($('.timerequest-row').first());
    });

    $('#submit').click(function(){
        if(window.confirm('Submit this application? You will no longer be able to edit it')){
            $('#id_status').val('SUBMITTED')
            $('#app_form').submit()
        }
    });
    $('#save').click(function(){
        $('#id_status').val('DRAFT')
        $('#app_form').submit()
    });
    $("#id_science_case_file").change(function(){
        if(!$("#id_science_case").val()){
            $("#id_science_case").val('Attached')
        }
    });
    $("#id_experimental_design_file").change(function(){
        if(!$("#id_experimental_design").val()){
            $("#id_experimental_design").val('Attached')
        }
    });
</script>
{% endblock %}
