{% extends 'base.html' %}
{% load i18n %}
{% block title %}Home{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-8">
    {% block request_list %}
    {% endblock %}
    </div>
    <div class="col-md-4">
        {% if user.is_authenticated %}
        {% include "partials/telescope_availability_chart.html" %}
        <div class="row">
            <div class="col-md-12">
                <h3>Active Proposals</h3>
                {% for proposal in user.proposal_set.all %}
                <p><a href="{% url 'proposals:detail' pk=proposal.id %}">{{ proposal }}</a>
                <br/>
                <small>{{ proposal.title }}</small>
                </p>
                {% empty %}
                <p>{% trans 'You have no proposals' %}</p>
                <p>
                    <a href="{% url 'sciapplications:index' %}">
                    {% trans 'Apply for time' %}
                    </a>
                </p>
                {% endfor %}
        {% endif %}
        <div class="row">
            <div class="col-md-12">
                <h3>News</h3>
                <div id="news">
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_javascript %}
{% load static bootstrap3 %}
<script src="{% static 'js/telescope_availability.js' %}"></script>
<script type="text/javascript">
$(document).ready(function(){
    var end_date = new Date();
    var start_date = new Date(end_date);
    start_date.setDate(start_date.getDate() - 3);
    start_date.setHours(0);
    start_date.setMinutes(0);
    start_date.setSeconds(0);
    var state_url = "{% url 'telescope_availability' %}" + "?start=" + 
                     start_date.toISOString() + "&end=" + end_date.toISOString()
    $.getJSON(state_url, function(data) {
        create_telescope_availability_chart(data);
    });
    $.ajax({
        url: 'https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=10&callback=?&q=' + encodeURIComponent('http://lcogt.net/blog/feeds/rss/'),
        dataType: 'json',
        success: function (data) {
            rss = '<ul class="list-unstyled">'
            if (data.responseData.feed && data.responseData.feed.entries) {
                $.each(data.responseData.feed.entries, function (i, e) {
                    time = new Date(e.publishedDate)
                    str_time = time.getDate() + '/' + (time.getMonth()+1) + '/' + time.getFullYear()
                    rss = rss + '<li><a href="' + e.link + '">' + e.title + '</a><small> ' + str_time + '</small></li>'
                });
            }
            rss = rss + '</ul>'
            $('#news').html(rss)
        }
    });
});
</script>
{% endblock %}
